name: ðŸš€ Deploy to Render

on:
  push:
    branches: [ main, olwal-qa ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests for emergency deployment'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

concurrency:
  group: render-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  quality-checks:
    name: ðŸŽ¨ Code Quality
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != true }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    - name: ðŸ“¦ Install dependencies
      working-directory: ./app
      run: |
        echo "::group::Installing dependencies"
        npm ci --prefer-offline --no-audit
        echo "::endgroup::"
    
    - name: ðŸŽ¨ Linting & Formatting
      working-directory: ./app
      run: |
        echo "::group::Running ESLint"
        npm run lint &
        LINT_PID=$!
        echo "::endgroup::"
        
        echo "::group::Checking Prettier formatting"
        npm run format:check &
        FORMAT_PID=$!
        echo "::endgroup::"
        
        # Wait for both to complete
        wait $LINT_PID
        LINT_EXIT=$?
        wait $FORMAT_PID
        FORMAT_EXIT=$?
        
        if [ $LINT_EXIT -ne 0 ]; then
          echo "âŒ Linting failed"
          exit 1
        fi
        
        if [ $FORMAT_EXIT -ne 0 ]; then
          echo "âŒ Formatting check failed"
          exit 1
        fi
        
        echo "âœ… Code quality checks passed!"
  
  tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != true }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    - name: ðŸ“¦ Install dependencies
      working-directory: ./app
      run: npm ci --prefer-offline --no-audit
    
    - name: ðŸ§ª Run Tests
      working-directory: ./app
      run: |
        echo "::group::Running test suite"
        npm test -- --run --reporter=verbose
        echo "::endgroup::"
  
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != true }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    - name: ðŸ“¦ Install dependencies
      working-directory: ./app
      run: npm ci --prefer-offline --no-audit
    
    - name: ðŸ”’ Security Audit
      working-directory: ./app
      run: |
        echo "::group::Running npm audit"
        npm audit --audit-level=high
        echo "::endgroup::"
  
  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [quality-checks, tests, security]
    if: always() && (needs.quality-checks.result == 'success' || needs.quality-checks.result == 'skipped') && (needs.tests.result == 'success' || needs.tests.result == 'skipped') && (needs.security.result == 'success' || needs.security.result == 'skipped')
    outputs:
      build_time: ${{ steps.timing.outputs.build_time }}
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    - name: ðŸ“¦ Install dependencies
      working-directory: ./app
      run: npm ci --prefer-offline --no-audit
    
    - name: ðŸ—ï¸ Build Application
      id: timing
      working-directory: ./app
      run: |
        START_TIME=$(date +%s)
        echo "::group::Building production bundle"
        npm run build
        echo "::endgroup::"
        END_TIME=$(date +%s)
        BUILD_TIME=$((END_TIME - START_TIME))
        echo "build_time=${BUILD_TIME}s" >> $GITHUB_OUTPUT
        
        echo "âœ… Build completed in ${BUILD_TIME}s"
        echo "ðŸ“Š Build artifacts:"
        ls -lh dist/
    
    - name: ðŸ“‹ Pre-Deploy Summary
      run: |
        echo "### âœ… Pre-Deploy Checks Passed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status | Duration |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ¨ Code Quality | âœ… Passed | Parallel |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ª Unit Tests | âœ… Passed | Parallel |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”’ Security Audit | âœ… Passed | Parallel |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Build | âœ… Passed | ${{ steps.timing.outputs.build_time }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âš¡ **Performance:** Quality checks ran in parallel for faster feedback!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
  
  deploy:
    name: ðŸš€ Deploy to Render
    needs: build
    runs-on: ubuntu-latest
    outputs:
      deploy_time: ${{ steps.deploy_timing.outputs.deploy_time }}
      deploy_url: ${{ secrets.RENDER_APP_URL }}
    
    steps:
    - name: ðŸ”” Deployment Started
      run: |
        echo "### ðŸš€ Deployment in Progress..." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° **Started:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ‘¤ **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ¿ **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Commit:** [\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸŽ¯ Trigger Render Deploy Hook
      id: deploy_timing
      run: |
        START_TIME=$(date +%s)
        echo "ðŸš€ Triggering Render deployment..."
        
        RESPONSE=$(curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
          -H "Content-Type: application/json" \
          -w "\n%{http_code}" \
          -s \
          --max-time 30)
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)
        END_TIME=$(date +%s)
        DEPLOY_TIME=$((END_TIME - START_TIME))
        
        echo "deploy_time=${DEPLOY_TIME}s" >> $GITHUB_OUTPUT
        echo "HTTP Status: $HTTP_CODE"
        echo "Response: $BODY"
        echo "âš¡ Deploy hook responded in ${DEPLOY_TIME}s"
        
        if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
          echo "âœ… Deployment triggered successfully!"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Deploy Hook Triggered Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Hook Response | ${DEPLOY_TIME}s |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build Time | ${{ needs.build.outputs.build_time }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Target URL | ${{ secrets.RENDER_APP_URL }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ Render is now building and deploying your application..." >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Deployment hook failed!"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âŒ Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**HTTP Status:** $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
          echo "**Response:** \`$BODY\`" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
  
  healthcheck:
    name: ðŸ¥ Health Check
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: â³ Wait for Render Deployment
      run: |
        echo "â³ Giving Render time to build and deploy..."
        echo "ðŸ“Š Estimated time: 2-3 minutes"
        
        # Smart wait with progress indicators
        for i in {1..6}; do
          echo "â° Waiting... ($i/6) - $((i * 15))s elapsed"
          sleep 15
        done
        
        echo "âœ… Initial wait complete. Starting health checks..."
    
    - name: ðŸ” Health Check with Smart Retry
      id: health
      run: |
        MAX_RETRIES=12
        RETRY_COUNT=0
        HEALTH_URL="${{ secrets.RENDER_APP_URL }}/api/health"
        START_TIME=$(date +%s)
        
        echo "ðŸ¥ Checking health endpoint: $HEALTH_URL"
        echo "ðŸ”„ Max retries: $MAX_RETRIES with exponential backoff"
        echo ""
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          
          # Make request with timeout
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 10 \
            --connect-timeout 5 \
            "$HEALTH_URL" 2>/dev/null || echo "000")
          
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))
          
          if [ "$RESPONSE" -eq 200 ]; then
            echo "âœ… Health check PASSED! (Attempt $RETRY_COUNT/$MAX_RETRIES)"
            echo "âš¡ Application is live and responding"
            echo "â±ï¸ Total time: ${ELAPSED}s"
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ¥ Health Status | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Verification Time | ${ELAPSED}s |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”„ Attempts Needed | $RETRY_COUNT/$MAX_RETRIES |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŒ Live URL | [${{ secrets.RENDER_APP_URL }}](${{ secrets.RENDER_APP_URL }}) |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ¥ Health Endpoint | [/api/health]($HEALTH_URL) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Deployment Timeline" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. âœ… Pre-deploy checks (Parallel: Quality + Tests + Security)" >> $GITHUB_STEP_SUMMARY
            echo "2. âœ… Build completed (Time: ${{ needs.build.outputs.build_time }})" >> $GITHUB_STEP_SUMMARY
            echo "3. âœ… Deploy hook triggered (${{ needs.deploy.outputs.deploy_time }})" >> $GITHUB_STEP_SUMMARY
            echo "4. âœ… Health verification (${ELAPSED}s)" >> $GITHUB_STEP_SUMMARY
            
            exit 0
          fi
          
          # Calculate exponential backoff (10s, 15s, 20s, 25s...)
          WAIT_TIME=$((10 + (RETRY_COUNT * 5)))
          if [ $WAIT_TIME -gt 30 ]; then
            WAIT_TIME=30
          fi
          
          echo "â³ Attempt $RETRY_COUNT/$MAX_RETRIES: Status $RESPONSE - Waiting ${WAIT_TIME}s before retry... (${ELAPSED}s elapsed)"
          sleep $WAIT_TIME
        done
        
        # Health check failed
        FINAL_TIME=$(date +%s)
        TOTAL_TIME=$((FINAL_TIME - START_TIME))
        
        echo "âš ï¸ Health check timeout after ${TOTAL_TIME}s"
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ Health Check Timeout" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Info | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| â±ï¸ Time Elapsed | ${TOTAL_TIME}s |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”„ Attempts Made | $MAX_RETRIES |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ¥ Last Status | $RESPONSE |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**â„¹ï¸ This doesn't mean deployment failed!**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Check [Render Dashboard](https://dashboard.render.com) for build status" >> $GITHUB_STEP_SUMMARY
        echo "2. Manually verify: [${{ secrets.RENDER_APP_URL }}](${{ secrets.RENDER_APP_URL }})" >> $GITHUB_STEP_SUMMARY
        echo "3. Check health: [$HEALTH_URL]($HEALTH_URL)" >> $GITHUB_STEP_SUMMARY
        echo "4. Review Render logs for any startup errors" >> $GITHUB_STEP_SUMMARY
        
        # Don't fail the workflow for timeout
        exit 0
