#!/usr/bin/env sh
set -e

echo "ğŸ” Running pre-commit checks..."

# Get the absolute path to the repository root
# When running from .git/hooks, we need to go up two levels
if [ -d ".git" ]; then
  # Running from repo root
  REPO_ROOT="$(pwd)"
else
  # Running from .git/hooks, go up two levels
  REPO_ROOT="$(cd "$(dirname -- "$0")/../.." && pwd)"
fi

# Change to app directory and run checks
cd "$REPO_ROOT/app"

# Check for secrets first (fail fast)
echo "ğŸ”’ Scanning for secrets..."
npm run check:secrets
if [ $? -ne 0 ]; then
  echo "âŒ Secret scan failed. Commit blocked."
  exit 1
fi

# Auto-fix linting and formatting issues on staged files only
echo "ğŸ¨ Auto-fixing linting and formatting issues..."
npx lint-staged

# Run tests (optional - skip if SKIP_TESTS=true)
if [ "$SKIP_TESTS" = "true" ]; then
  echo "â­ï¸ Skipping tests (SKIP_TESTS=true)"
else
  echo "ğŸ§ª Running tests..."
  npm test
fi

echo "âœ… All pre-commit checks passed!"
